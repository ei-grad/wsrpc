this.msgpack||function(n){function x(a,b,m){var c,e,k;if(null==b)a.push(192);else if(!1===b)a.push(194);else if(!0===b)a.push(195);else switch(typeof b){case "number":b!==b?a.push(203,255,255,255,255,255,255,255,255):Infinity===b?a.push(203,127,240,0,0,0,0,0,0):Math.floor(b)===b?0>b?-32<=b?a.push(224+b+32):-128<b?a.push(208,b+256):-32768<b?(b+=65536,a.push(209,b>>8,b&255)):-2147483648<b?(b+=4294967296,a.push(210,b>>>24,b>>16&255,b>>8&255,b&255)):(e=Math.floor(b/4294967296),b&=4294967295,a.push(211,
e>>24&255,e>>16&255,e>>8&255,e&255,b>>24&255,b>>16&255,b>>8&255,b&255)):128>b?a.push(b):256>b?a.push(204,b):65536>b?a.push(205,b>>8,b&255):4294967296>b?a.push(206,b>>>24,b>>16&255,b>>8&255,b&255):(e=Math.floor(b/4294967296),b&=4294967295,a.push(207,e>>24&255,e>>16&255,e>>8&255,e&255,b>>24&255,b>>16&255,b>>8&255,b&255)):((e=0>b)&&(b*=-1),k=Math.log(b)/.6931471805599453+1023|0,m=b*Math.pow(2,1075-k),b=m&4294967295,e&&(k|=2048),e=m/4294967296&1048575|k<<20,a.push(203,e>>24&255,e>>16&255,e>>8&255,e&255,
b>>24&255,b>>16&255,b>>8&255,b&255));break;case "string":m=b.length;k=a.length;a.push(0);for(e=0;e<m;++e)c=b.charCodeAt(e),128>c?a.push(c&127):2048>c?a.push(c>>>6&31|192,c&63|128):65536>c&&a.push(c>>>12&15|224,c>>>6&63|128,c&63|128);c=a.length-k-1;32>c?a[k]=160+c:65536>c?a.splice(k,1,218,c>>8,c&255):4294967296>c&&a.splice(k,1,219,c>>>24,c>>16&255,c>>8&255,c&255);break;default:if(++m>=h)return d=1,[];if(t(b))for(c=b.length,16>c?a.push(144+c):65536>c?a.push(220,c>>8,c&255):4294967296>c&&a.push(221,
c>>>24,c>>16&255,c>>8&255,c&255),e=0;e<c;++e)x(a,b[e],m);else{k=a.length;a.push(0);c=0;for(e in b)++c,x(a,e,m),x(a,b[e],m);16>c?a[k]=128+c:65536>c?a.splice(k,1,222,c>>8,c&255):4294967296>c&&a.splice(k,1,223,c>>>24,c>>16&255,c>>8&255,c&255)}}return a}function y(){var b,d,h,c=0,e,k,f=u;d=f[++a];if(224<=d)return d-256;if(192>d){if(128>d)return d;144>d?(c=d-128,d=128):160>d?(c=d-144,d=144):(c=d-160,d=160)}switch(d){case 192:return null;case 194:return!1;case 195:return!0;case 202:return c=16777216*f[++a]+
(f[++a]<<16)+(f[++a]<<8)+f[++a],e=c>>23&255,k=c&8388607,c&&2147483648!==c?255===e?k?NaN:Infinity:(c&2147483648?-1:1)*(k|8388608)*Math.pow(2,e-127-23):0;case 203:c=16777216*f[++a]+(f[++a]<<16)+(f[++a]<<8)+f[++a];d=c&2147483648;e=c>>20&2047;k=c&1048575;if(!c||2147483648===c)return a+=4,0;if(2047===e)return a+=4,k?NaN:Infinity;c=16777216*f[++a]+(f[++a]<<16)+(f[++a]<<8)+f[++a];return(d?-1:1)*((k|1048576)*Math.pow(2,e-1023-20)+c*Math.pow(2,e-1023-52));case 207:return c=16777216*f[++a]+(f[++a]<<16)+(f[++a]<<
8)+f[++a],4294967296*c+16777216*f[++a]+(f[++a]<<16)+(f[++a]<<8)+f[++a];case 206:c+=16777216*f[++a]+(f[++a]<<16);case 205:c+=f[++a]<<8;case 204:return c+f[++a];case 211:return c=f[++a],c&128?-1*(72057594037927936*(c^255)+281474976710656*(f[++a]^255)+1099511627776*(f[++a]^255)+4294967296*(f[++a]^255)+16777216*(f[++a]^255)+65536*(f[++a]^255)+256*(f[++a]^255)+(f[++a]^255)+1):72057594037927936*c+281474976710656*f[++a]+1099511627776*f[++a]+4294967296*f[++a]+16777216*f[++a]+65536*f[++a]+256*f[++a]+f[++a];
case 210:return c=16777216*f[++a]+(f[++a]<<16)+(f[++a]<<8)+f[++a],2147483648>c?c:c-4294967296;case 209:return c=(f[++a]<<8)+f[++a],32768>c?c:c-65536;case 208:return c=f[++a],128>c?c:c-256;case 219:c+=16777216*f[++a]+(f[++a]<<16);case 218:c+=(f[++a]<<8)+f[++a];case 160:e=[];d=a;for(b=d+c;d<b;)h=f[++d],e.push(128>h?h:224>h?(h&31)<<6|f[++d]&63:(h&15)<<12|(f[++d]&63)<<6|f[++d]&63);a=d;return 10240>e.length?v.apply(null,e):w(e);case 223:c+=16777216*f[++a]+(f[++a]<<16);case 222:c+=(f[++a]<<8)+f[++a];case 128:for(k=
{};c--;){b=f[++a]-160;e=[];d=a;for(b=d+b;d<b;)h=f[++d],e.push(128>h?h:224>h?(h&31)<<6|f[++d]&63:(h&15)<<12|(f[++d]&63)<<6|f[++d]&63);a=d;k[v.apply(null,e)]=y()}return k;case 221:c+=16777216*f[++a]+(f[++a]<<16);case 220:c+=(f[++a]<<8)+f[++a];case 144:for(e=[];c--;)e.push(y());return e}}function w(b){try{return v.apply(this,b)}catch(a){}for(var d=[],c=0,e=b.length,h=p;c<e;++c)d[c]=h[b[c]];return d.join("")}n.msgpack={pack:function(b,a){d=0;var h=x([],b,0);return d?!1:a?w(h):h},unpack:function(d){var h;
if("string"===typeof d){h=[];var m=b,c=d.split(""),e=-1,k;k=c.length;for(d=k%8;d--;)++e,h[e]=m[c[e]];for(d=k>>3;d--;)h.push(m[c[++e]],m[c[++e]],m[c[++e]],m[c[++e]],m[c[++e]],m[c[++e]],m[c[++e]],m[c[++e]])}else h=d;u=h;a=-1;return y()}};var b={},p={},u=[],a=0,d=0,t=Array.isArray||function(b){return"[object Array]"===Object.prototype.toString.call(b)},v=String.fromCharCode,h=512;(function(){for(var a=0,d;256>a;++a)d=v(a),b[d]=a,p[a]=d;for(a=128;256>a;++a)b[v(63232+a)]=a})()}(this);(function(n){if("function"===typeof bootstrap)bootstrap("promise",n);else if("object"===typeof exports&&"object"===typeof module)module.exports=n();else if("function"===typeof define&&define.amd)define(n);else if("undefined"!==typeof ses)ses.ok()&&(ses.makeQ=n);else if("undefined"!==typeof self)self.Q=n();else throw Error("This environment was not anticiapted by Q. Please file a bug.");})(function(){function n(g){return function(){return R.apply(g,arguments)}}function x(g,r){if(D&&r.stack&&"object"===
typeof g&&null!==g&&g.stack&&-1===g.stack.indexOf("From previous event:")){for(var b=[],a=r;a;a=a.source)a.stack&&b.unshift(a.stack);b.unshift(g.stack);for(var b=b.join("\nFrom previous event:\n").split("\n"),a=[],c=0;c<b.length;++c){var d=b[c],e;if(e=y(d)){var f=e[1];e=e[0]===M&&f>=S&&f<=T}else e=!1;e||(e=d,e=-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:"));e||!d||a.push(d)}b=a.join("\n");g.stack=b}}function y(g){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(g);if(b||(b=/at ([^ ]+):(\d+):(?:\d+)$/.exec(g)))return[b[1],
Number(b[2])];if(g=/.*@(.+):(\d+)$/.exec(g))return[g[1],Number(g[2])]}function w(){if(D)try{throw Error();}catch(g){var b=g.stack.split("\n"),b=0<b[0].indexOf("@")?b[1]:b[2];if(b=y(b))return M=b[0],b[1]}}function b(g){return g instanceof d?g:l(g)?k(g):e(g)}function p(){function g(g){f=g;z.source=g;E(r,function(r,a){b.nextTick(function(){g.promiseDispatch.apply(g,a)})},void 0);a=r=void 0}var r=[],a=[],f,k=H(p.prototype),z=H(d.prototype);z.promiseDispatch=function(g,c,d){var e=q(arguments);r?(r.push(e),
"when"===c&&d[1]&&a.push(d[1])):b.nextTick(function(){f.promiseDispatch.apply(f,e)})};z.valueOf=function(){if(r)return z;var g=v(f);h(g)&&(f=g);return g};z.inspect=function(){return f?f.inspect():{state:"pending"}};if(b.longStackSupport&&D)try{throw Error();}catch(l){z.stack=l.stack.substring(l.stack.indexOf("\n")+1)}k.promise=z;k.resolve=function(r){f||g(b(r))};k.fulfill=function(b){f||g(e(b))};k.reject=function(b){f||g(c(b))};k.notify=function(g){f||E(a,function(r,a){b.nextTick(function(){a(g)})},
void 0)};return k}function u(g){if("function"!==typeof g)throw new TypeError("resolver must be a function.");var b=p();try{g(b.resolve,b.reject,b.notify)}catch(a){b.reject(a)}return b.promise}function a(g){return u(function(a,c){for(var d=0,e=g.length;d<e;d++)b(g[d]).then(a,c)})}function d(g,b,a){void 0===b&&(b=function(g){return c(Error("Promise does not support operation: "+g))});void 0===a&&(a=function(){return{state:"unknown"}});var e=H(d.prototype);e.promiseDispatch=function(a,d,L){var f;try{f=
g[d]?g[d].apply(e,L):b.call(e,d,L)}catch(h){f=c(h)}a&&a(f)};if(e.inspect=a){var f=a();"rejected"===f.state&&(e.exception=f.reason);e.valueOf=function(){var g=a();return"pending"===g.state||"rejected"===g.state?e:g.value}}return e}function t(g,a,c,d){return b(g).then(a,c,d)}function v(g){if(h(g)){var b=g.inspect();if("fulfilled"===b.state)return b.value}return g}function h(g){return g instanceof d}function l(g){return g===Object(g)&&"function"===typeof g.then}function G(){B.length=0;F.length=0;C||
(C=!0)}function m(g,b){C&&(F.push(g),b&&"undefined"!==typeof b.stack?B.push(b.stack):B.push("(no stack) "+b))}function c(g){var b=d({when:function(b){if(b&&C){var a=U(F,this);-1!==a&&(F.splice(a,1),B.splice(a,1))}return b?b(g):this}},function(){return this},function(){return{state:"rejected",reason:g}});m(b,g);return b}function e(b){return d({when:function(){return b},get:function(a){return b[a]},set:function(a,c){b[a]=c},"delete":function(a){delete b[a]},post:function(a,c){return null===a||void 0===
a?b.apply(void 0,c):b[a].apply(b,c)},apply:function(a,c){return b.apply(a,c)},keys:function(){return V(b)}},void 0,function(){return{state:"fulfilled",value:b}})}function k(g){var a=p();b.nextTick(function(){try{g.then(a.resolve,a.reject,a.notify)}catch(b){a.reject(b)}});return a.promise}function f(g,a,c){return b(g).spread(a,c)}function N(g,a,c){return b(g).dispatch(a,c)}function A(b){return t(b,function(b){var g=0,a=p();E(b,function(c,d,e){var f;h(d)&&"fulfilled"===(f=d.inspect()).state?b[e]=f.value:
(++g,t(d,function(c){b[e]=c;0===--g&&a.resolve(b)},a.reject,function(b){a.notify({index:e,value:b})}))},void 0);0===g&&a.resolve(b);return a.promise})}function O(a){return t(a,function(a){a=I(a,b);return t(A(I(a,function(b){return t(b,P,P)})),function(){return a})})}var D=!1;try{throw Error();}catch(W){D=!!W.stack}var S=w(),M,P=function(){},J=function(){function b(){for(;a.next;){a=a.next;var c=a.task;a.task=void 0;var e=a.domain;e&&(a.domain=void 0,e.enter());try{c()}catch(h){if(f)throw e&&e.exit(),
setTimeout(b,0),e&&e.enter(),h;setTimeout(function(){throw h;},0)}e&&e.exit()}d=!1}var a={task:void 0,next:null},c=a,d=!1,e=void 0,f=!1;J=function(b){c=c.next={task:b,domain:f&&process.domain,next:null};d||(d=!0,e())};if("undefined"!==typeof process&&process.nextTick)f=!0,e=function(){process.nextTick(b)};else if("function"===typeof setImmediate)e="undefined"!==typeof window?setImmediate.bind(window,b):function(){setImmediate(b)};else if("undefined"!==typeof MessageChannel){var h=new MessageChannel;
h.port1.onmessage=function(){e=k;h.port1.onmessage=b;b()};var k=function(){h.port2.postMessage(0)},e=function(){setTimeout(b,0);k()}}else e=function(){setTimeout(b,0)};return J}(),R=Function.call,q=n(Array.prototype.slice),E=n(Array.prototype.reduce||function(b,a){var c=0,d=this.length;if(1===arguments.length){do{if(c in this){a=this[c++];break}if(++c>=d)throw new TypeError;}while(1)}for(;c<d;c++)c in this&&(a=b(a,this[c],c));return a}),U=n(Array.prototype.indexOf||function(b){for(var a=0;a<this.length;a++)if(this[a]===
b)return a;return-1}),I=n(Array.prototype.map||function(b,a){var c=this,d=[];E(c,function(e,f,h){d.push(b.call(a,f,h,c))},void 0);return d}),H=Object.create||function(b){function a(){}a.prototype=b;return new a},X=n(Object.prototype.hasOwnProperty),V=Object.keys||function(b){var a=[],c;for(c in b)X(b,c)&&a.push(c);return a},Y=n(Object.prototype.toString),K;K="undefined"!==typeof ReturnValue?ReturnValue:function(b){this.value=b};b.resolve=b;b.nextTick=J;b.longStackSupport=!1;"object"===typeof process&&
process&&process.env&&process.env.Q_DEBUG&&(b.longStackSupport=!0);b.defer=p;p.prototype.makeNodeResolver=function(){var b=this;return function(a,c){a?b.reject(a):2<arguments.length?b.resolve(q(arguments,1)):b.resolve(c)}};b.Promise=u;b.promise=u;u.race=a;u.all=A;u.reject=c;u.resolve=b;b.passByCopy=function(b){return b};d.prototype.passByCopy=function(){return this};b.join=function(a,c){return b(a).join(c)};d.prototype.join=function(a){return b([this,a]).spread(function(b,a){if(b===a)return b;throw Error("Can't join: not the same: "+
b+" "+a);})};b.race=a;d.prototype.race=function(){return this.then(b.race)};b.makePromise=d;d.prototype.toString=function(){return"[object Promise]"};d.prototype.then=function(a,d,e){function f(b){try{return"function"===typeof a?a(b):b}catch(d){return c(d)}}function h(b){if("function"===typeof d){x(b,k);try{return d(b)}catch(a){return c(a)}}return c(b)}var k=this,l=p(),m=!1;b.nextTick(function(){k.promiseDispatch(function(b){m||(m=!0,l.resolve(f(b)))},"when",[function(b){m||(m=!0,l.resolve(h(b)))}])});
k.promiseDispatch(void 0,"when",[void 0,function(a){var g,c=!1;try{g="function"===typeof e?e(a):a}catch(d){if(c=!0,b.onerror)b.onerror(d);else throw d;}c||l.notify(g)}]);return l.promise};b.tap=function(a,c){return b(a).tap(c)};d.prototype.tap=function(a){a=b(a);return this.then(function(b){return a.fcall(b).thenResolve(b)})};b.when=t;d.prototype.thenResolve=function(b){return this.then(function(){return b})};b.thenResolve=function(a,c){return b(a).thenResolve(c)};d.prototype.thenReject=function(b){return this.then(function(){throw b;
})};b.thenReject=function(a,c){return b(a).thenReject(c)};b.nearer=v;b.isPromise=h;b.isPromiseAlike=l;b.isPending=function(b){return h(b)&&"pending"===b.inspect().state};d.prototype.isPending=function(){return"pending"===this.inspect().state};b.isFulfilled=function(b){return!h(b)||"fulfilled"===b.inspect().state};d.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state};b.isRejected=function(b){return h(b)&&"rejected"===b.inspect().state};d.prototype.isRejected=function(){return"rejected"===
this.inspect().state};var B=[],F=[],C=!0;b.resetUnhandledRejections=G;b.getUnhandledReasons=function(){return B.slice()};b.stopUnhandledRejectionTracking=function(){G();C=!1};G();b.reject=c;b.fulfill=e;b.master=function(a){return d({isDef:function(){}},function(b,c){return N(a,b,c)},function(){return b(a).inspect()})};b.spread=f;d.prototype.spread=function(b,a){return this.all().then(function(a){return b.apply(void 0,a)},a)};b.async=function(a){return function(){function d(a,g){var r;if("undefined"===
typeof StopIteration){try{r=e[a](g)}catch(k){return c(k)}return r.done?b(r.value):t(r.value,f,h)}try{r=e[a](g)}catch(l){return"[object StopIteration]"===Y(l)||l instanceof K?b(l.value):c(l)}return t(r,f,h)}var e=a.apply(this,arguments),f=d.bind(d,"next"),h=d.bind(d,"throw");return f()}};b.spawn=function(a){b.done(b.async(a)())};b["return"]=function(b){throw new K(b);};b.promised=function(b){return function(){return f([this,A(arguments)],function(a,c){return b.apply(a,c)})}};b.dispatch=N;d.prototype.dispatch=
function(a,c){var d=this,e=p();b.nextTick(function(){d.promiseDispatch(e.resolve,a,c)});return e.promise};b.get=function(a,c){return b(a).dispatch("get",[c])};d.prototype.get=function(b){return this.dispatch("get",[b])};b.set=function(a,c,d){return b(a).dispatch("set",[c,d])};d.prototype.set=function(b,a){return this.dispatch("set",[b,a])};b.del=b["delete"]=function(a,c){return b(a).dispatch("delete",[c])};d.prototype.del=d.prototype["delete"]=function(b){return this.dispatch("delete",[b])};b.mapply=
b.post=function(a,c,d){return b(a).dispatch("post",[c,d])};d.prototype.mapply=d.prototype.post=function(b,a){return this.dispatch("post",[b,a])};b.send=b.mcall=b.invoke=function(a,c){return b(a).dispatch("post",[c,q(arguments,2)])};d.prototype.send=d.prototype.mcall=d.prototype.invoke=function(b){return this.dispatch("post",[b,q(arguments,1)])};b.fapply=function(a,c){return b(a).dispatch("apply",[void 0,c])};d.prototype.fapply=function(b){return this.dispatch("apply",[void 0,b])};b["try"]=b.fcall=
function(a){return b(a).dispatch("apply",[void 0,q(arguments,1)])};d.prototype.fcall=function(){return this.dispatch("apply",[void 0,q(arguments)])};b.fbind=function(a){var c=b(a),d=q(arguments,1);return function(){return c.dispatch("apply",[this,d.concat(q(arguments))])}};d.prototype.fbind=function(){var b=this,a=q(arguments);return function(){return b.dispatch("apply",[this,a.concat(q(arguments))])}};b.keys=function(a){return b(a).dispatch("keys",[])};d.prototype.keys=function(){return this.dispatch("keys",
[])};b.all=A;d.prototype.all=function(){return A(this)};b.allResolved=function(b,a,c){return function(){"undefined"!==typeof console&&"function"===typeof console.warn&&console.warn(a+" is deprecated, use "+c+" instead.",Error("").stack);return b.apply(b,arguments)}}(O,"allResolved","allSettled");d.prototype.allResolved=function(){return O(this)};b.allSettled=function(a){return b(a).allSettled()};d.prototype.allSettled=function(){return this.then(function(a){return A(I(a,function(a){function c(){return a.inspect()}
a=b(a);return a.then(c,c)}))})};b.fail=b["catch"]=function(a,c){return b(a).then(void 0,c)};d.prototype.fail=d.prototype["catch"]=function(b){return this.then(void 0,b)};b.progress=function(a,c){return b(a).then(void 0,void 0,c)};d.prototype.progress=function(b){return this.then(void 0,void 0,b)};b.fin=b["finally"]=function(a,c){return b(a)["finally"](c)};d.prototype.fin=d.prototype["finally"]=function(a){a=b(a);return this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b;
})})};b.done=function(a,c,d,e){return b(a).done(c,d,e)};d.prototype.done=function(a,c,d){var e=function(a){b.nextTick(function(){x(a,f);if(b.onerror)b.onerror(a);else throw a;})},f=a||c||d?this.then(a,c,d):this;"object"===typeof process&&process&&process.domain&&(e=process.domain.bind(e));f.then(void 0,e)};b.timeout=function(a,c,d){return b(a).timeout(c,d)};d.prototype.timeout=function(a,b){var c=p(),d=setTimeout(function(){b&&"string"!==typeof b||(b=Error(b||"Timed out after "+a+" ms"),b.code="ETIMEDOUT");
c.reject(b)},a);this.then(function(a){clearTimeout(d);c.resolve(a)},function(a){clearTimeout(d);c.reject(a)},c.notify);return c.promise};b.delay=function(a,c){void 0===c&&(c=a,a=void 0);return b(a).delay(c)};d.prototype.delay=function(a){return this.then(function(b){var c=p();setTimeout(function(){c.resolve(b)},a);return c.promise})};b.nfapply=function(a,c){return b(a).nfapply(c)};d.prototype.nfapply=function(a){var b=p();a=q(a);a.push(b.makeNodeResolver());this.fapply(a).fail(b.reject);return b.promise};
b.nfcall=function(a){var c=q(arguments,1);return b(a).nfapply(c)};d.prototype.nfcall=function(){var a=q(arguments),b=p();a.push(b.makeNodeResolver());this.fapply(a).fail(b.reject);return b.promise};b.nfbind=b.denodeify=function(a){var c=q(arguments,1);return function(){var d=c.concat(q(arguments)),e=p();d.push(e.makeNodeResolver());b(a).fapply(d).fail(e.reject);return e.promise}};d.prototype.nfbind=d.prototype.denodeify=function(){var a=q(arguments);a.unshift(this);return b.denodeify.apply(void 0,
a)};b.nbind=function(a,c){var d=q(arguments,2);return function(){var e=d.concat(q(arguments)),f=p();e.push(f.makeNodeResolver());b(function(){return a.apply(c,arguments)}).fapply(e).fail(f.reject);return f.promise}};d.prototype.nbind=function(){var a=q(arguments,0);a.unshift(this);return b.nbind.apply(void 0,a)};b.nmapply=b.npost=function(a,c,d){return b(a).npost(c,d)};d.prototype.nmapply=d.prototype.npost=function(a,b){var c=q(b||[]),d=p();c.push(d.makeNodeResolver());this.dispatch("post",[a,c]).fail(d.reject);
return d.promise};b.nsend=b.nmcall=b.ninvoke=function(a,c){var d=q(arguments,2),e=p();d.push(e.makeNodeResolver());b(a).dispatch("post",[c,d]).fail(e.reject);return e.promise};d.prototype.nsend=d.prototype.nmcall=d.prototype.ninvoke=function(a){var b=q(arguments,1),c=p();b.push(c.makeNodeResolver());this.dispatch("post",[a,b]).fail(c.reject);return c.promise};b.nodeify=function(a,c){return b(a).nodeify(c)};d.prototype.nodeify=function(a){if(a)this.then(function(c){b.nextTick(function(){a(null,c)})},
function(c){b.nextTick(function(){a(c)})});else return this};var T=w();return b});(function(n){n.WSRPC=function(x,y){function w(a){return new Uint8Array(msgpack.pack(a))}function b(a){a=new Uint8Array(a.data);return msgpack.unpack(a)}function p(b){setTimeout(function(){try{a.socket=u(),a.serial=1}catch(l){b("onerror",l),delete a.socket,d(l)}},y||1E3)}function u(h){function l(b,e){for(;0<a.oneTimeEventStore[b].length;){var h=a.oneTimeEventStore[b].shift();h.hasOwnProperty("resolve")&&h.promise.isPending()&&h.resolve()}for(var f in a.eventStore[b]){h=a.eventStore[b][f];try{h(e)}catch(l){l.hasOwnProperty("stack")?
d(l.stack):d("Event function "+h+" raised unknown error: "+l)}}}var n=new WebSocket(x);n.binaryType="arraybuffer";var m=function(){for(a.connectionNumber++;0<a.callQueue.length;){var b=a.callQueue.shift(),d=a.store[b.serial];delete a.store[b.serial];d&&d.promise.isPending()&&d.reject("WebSocket error occurred")}};n.onclose=function(b){d("WSRPC: ONCLOSE CALLED (STATE: "+a["public"].state()+")");t(b);for(var e in a.store)a.store[e].hasOwnProperty("reject")&&a.store[e].promise.isPending()&&a.store[e].reject("Connection closed");
m();l("onclose",h);l("onchange",h);p(l)};n.onerror=function(b){d("WSRPC: ONERROR CALLED (STATE: "+a["public"].state()+")");t(b);m();l("onerror",b);l("onchange",b);d(["WebSocket has been closed by error: ",b])};n.onopen=function(b){d("WSRPC: ONOPEN CALLED (STATE: "+a["public"].state()+")");for(t(b);0<a.callQueue.length;)a.socket.send(w(a.callQueue.shift()));l("onconnect",b);l("onchange",b)};n.onmessage=function(c){d("WSRPC: ONMESSAGE CALLED ("+a["public"].state()+")");t(c);var e=null;if("message"==
c.type)try{if(e=b(c),d(e.data),e.hasOwnProperty("type")&&"call"===e.type){if(!a.routes.hasOwnProperty(e.call))throw Error("Route not found");var h=a.connectionNumber;Q(a.routes[e.call](e.arguments)).then(function(b){h==a.connectionNumber&&a.socket.send(w({serial:e.serial,type:"callback",data:b}))}).done()}else if(e.hasOwnProperty("type")&&"error"===e.type){if(!a.store.hasOwnProperty(e.serial))return d("Unknown callback");var f=a.store[e.serial];if("undefined"===typeof f)return d("Confirmation without handler");
delete a.store[e.serial];d("REJECTING: "+e.data);f.reject(e.data)}else{f=a.store[e.serial];if("undefined"===typeof f)return d("Confirmation without handler");delete a.store[e.serial];return"callback"===e.type?f.resolve(e.data):f.reject(e.data)}}catch(l){a.socket.send(w({data:l.message,type:"error",serial:e?e.serial:null})),d(l.stack)}};return n}var a=this;a.serial=1;a.eventId=0;a.socketStarted=!1;a.eventStore={onconnect:{},onerror:{},onclose:{},onchange:{}};a.connectionNumber=0;a.oneTimeEventStore=
{onconnect:[],onerror:[],onclose:[],onchange:[]};a.callQueue=[];var d=function(a){n.WSRPC.DEBUG&&("group"in console&&"groupEnd"in console?(console.group("WSRPC.DEBUG"),console.debug(a),console.groupEnd()):console.debug(a))},t=function(a){n.WSRPC.TRACE&&("group"in console&&"groupEnd"in console&&"dir"in console?(console.group("WSRPC.TRACE"),"data"in a?console.dir(b(a)):console.dir(a),console.groupEnd()):"data"in a?console.log("OBJECT DUMP: "+a.data):console.log("OBJECT DUMP: "+a))},v={0:"CONNECTING",
1:"OPEN",2:"CLOSING",3:"CLOSED"};a.routes={};a.store={};a["public"]={call:function(b,l,n){a.serial+=2;var m=Q.defer();b={serial:a.serial,call:b,arguments:l};l=a["public"].state();"OPEN"===l?(a.store[a.serial]=m,a.socket.send(w(b))):"CONNECTING"===l?(d("SOCKET IS: "+l),a.store[a.serial]=m,a.callQueue.push(b)):(d("SOCKET IS: "+l),n&&n.noWait?m.reject("Socket is: "+l):(a.store[a.serial]=m,a.callQueue.push(b)));return m.promise},init:function(){d("Websocket initializing..")},addRoute:function(b,d){a.routes[b]=
d},addEventListener:function(b,d){return a.eventStore[b][a.eventId++]=d},onEvent:function(b){var d=Q.defer();a.oneTimeEventStore[b].push(d);return d.promise},removeEventListener:function(b,d){return d<a.eventStore[b].length?(a.eventStore[b].splice(d,1),!0):!1},deleteRoute:function(b){return delete a.routes[b]},destroy:function(){function b(){}a.socket.onclose=b;a.socket.onerror=b;return a.socket.close()},state:function(){return a.socketStarted&&a.socket?v[a.socket.readyState]:v[3]},connect:function(){a.socketStarted=
!0;a.socket=u()}};a["public"].addRoute("log",function(a){console.info("Websocket sent: "+a)});a["public"].addRoute("ping",function(a){return a});return a["public"]};n.WSRPC.DEBUG=!1;n.WSRPC.TRACE=!1})(this);